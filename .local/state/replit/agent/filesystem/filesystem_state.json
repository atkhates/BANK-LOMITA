{"file_contents":{"models/user.js":{"content":"const mongoose = require('mongoose');\n\nconst userSchema = new mongoose.Schema({\n  userId: String,\n  name: String,\n  birthdate: String,\n  gender: String,\n  country: String,\n  rank: { type: String, default: \"Bronze\" },\n  salary: { type: Number, default: 100 },\n  status: { type: String, default: \"pending\" }, // accepted / rejected / blacklist\n});\n\nmodule.exports = mongoose.model(\"User\", userSchema);\n","size_bytes":400},"replit.md":{"content":"# Discord Bank Bot\n\n## Overview\nA Discord bot that manages a virtual banking system with Arabic UI. Users can register accounts, transfer funds, check balances, and admins can manage accounts through a comprehensive admin panel.\n\n## Project Details\n- **Language**: Node.js (JavaScript)\n- **Main Framework**: discord.js v14\n- **Database**: File-based JSON storage\n- **Language Support**: Arabic (UI and messages)\n\n## Architecture\n\n### How Everything Connects\n\nThe bot follows a modular architecture where **`index.js`** is the central orchestrator:\n\n```\nindex.js (Main Hub)\nâ”œâ”€â”€ Commands (./commands/*.js)\nâ”‚   â”œâ”€â”€ register.js â†’ Shows registration modal\nâ”‚   â”œâ”€â”€ account.js â†’ Displays user balance/info\nâ”‚   â”œâ”€â”€ transfer.js â†’ Handles money transfers\nâ”‚   â”œâ”€â”€ withdraw.js â†’ Processes withdrawals\nâ”‚   â”œâ”€â”€ rank.js â†’ Shows available ranks\nâ”‚   â”œâ”€â”€ admin.js â†’ Admin control panel\nâ”‚   â”œâ”€â”€ reglist.js â†’ Registration statistics\nâ”‚   â”œâ”€â”€ setup.js â†’ Per-guild configuration\nâ”‚   â””â”€â”€ support.js â†’ Support ticket system\nâ”‚\nâ”œâ”€â”€ Configuration & Permissions\nâ”‚   â”œâ”€â”€ guildConfig.js â†’ Per-guild settings (multi-server support)\nâ”‚   â”œâ”€â”€ guildConfigs.json â†’ Stored guild configurations\nâ”‚   â”œâ”€â”€ config.json â†’ Default configuration template\nâ”‚   â””â”€â”€ permissions.json â†’ Role-based permission mapping\nâ”‚\nâ”œâ”€â”€ Data Persistence\nâ”‚   â”œâ”€â”€ database/users.json â†’ User accounts & balances\nâ”‚   â””â”€â”€ database/transactions.json â†’ Transaction history\nâ”‚\nâ””â”€â”€ Google Sheets Integration (Optional)\n    â””â”€â”€ sheets.js â†’ Real-time sync with Google Sheets\n```\n\n### Core Files\n\n**Main Entry Point:**\n- `index.js` - Central orchestrator that:\n  - Loads all command modules from `./commands/`\n  - Handles all Discord interactions (slash commands, buttons, modals, select menus)\n  - Provides helper functions to commands: `loadUsers()`, `saveUsers()`, `pushTx()`, `updateRegList()`, `pushLog()`\n  - Enforces permissions using `hasPermission()` with data from `permissions.json`\n  - Manages registration flow with multi-step modals and selects\n  - Syncs data to Google Sheets (if configured)\n\n**Configuration Management:**\n- `guildConfig.js` - Per-guild configuration accessor\n  - Exports: `get(guildId)`, `set(guildId, config)`, `patch(guildId, updates)`\n  - Allows multi-server bot deployment with separate settings per server\n  - Falls back to `config.json` defaults\n- `permissions.json` - Role-based permissions for admin actions\n  - Maps role IDs to permissions: approve, reject, addBalance, editInfo, editFee, etc.\n\n**Data Layer:**\n- `database/users.json` - User data storage (auto-created)\n- `database/transactions.json` - Transaction log (auto-created)\n- `sheets.js` - Optional Google Sheets integration\n  - Safely wrapped: if unavailable, bot uses no-op methods\n  - Syncs users and transactions in real-time\n  - Auto-creates \"Users\" and \"Transactions\" sheets\n\n**Command Registration:**\n- `deploy-commands.js` - Registers slash commands with Discord API\n  - Must be run when commands are added/modified\n  - Supports both guild-specific (instant) and global deployment (1 hour)\n\n### User Model\nEach user record contains:\n- Personal info: name, country, age, birth date\n- Account info: balance, rank, status (pending/approved/rejected/blacklisted)\n- Type info: kind (Ù…Ø¯Ù†ÙŠ/Ø¹ØµØ§Ø¨Ø©/ÙØµÙŠÙ„), faction (for ÙØµÙŠÙ„ type)\n- Freeze status and income\n\n## Setup\n\n### Required Secrets\nThe following environment variables are required:\n- `TOKEN` - Discord bot token from Discord Developer Portal\n- `CLIENT_ID` - Discord application client ID\n\n### Configuration\n\nUse the `/setup` command to configure all channels for your server:\n\n**Required Channels:**\n- `register_channel` - Channel where users can register accounts\n- `review_channel` - Channel for admin review of registrations\n\n**Optional Channels:**\n- `reglist_channel` - Channel showing registration statistics summary\n- `log_channel` - **Admin activity log** - All admin actions and user transactions\n- `transaction_log_channel` - **Detailed transaction embeds** - Beautiful formatted transaction logs\n- `admin_role` - Role ID for administrators\n\n**Admin Log Channel (log_channel):**\nThis channel logs EVERYTHING that happens in the bot:\n- âœ… User registration approvals/rejections\n- ğŸ“ˆ Rank changes\n- ğŸ§Š Account freeze/unfreeze\n- â›” Blacklist actions\n- âœï¸ User information edits\n- ğŸ’µ Fee changes\n- ğŸ’° Admin deposits\n- ğŸ’¸ Admin withdrawals\n- ğŸ’¸ User transfers\n- ğŸ’° User withdrawals\n- ğŸ“¥ Data restores from Google Sheets\n\n**Transaction Log Channel (transaction_log_channel):**\nShows detailed embeds for financial transactions only:\n- ğŸ’¸ **User Transfers** - Sender, receiver, amount, fees, remaining balance\n- ğŸ’° **User Withdrawals** - User, amount, fees, remaining balance\n- â• **Admin Deposits** - Admin, recipient, amount, new balance\n- â– **Admin Withdrawals** - Admin, user, amount, fees, remaining balance\n\n**Other Configuration:**\n- `CURRENCY_SYMBOL` - Currency symbol (default: $)\n- `ranks` - Available account ranks\n- `fees` - Transaction fees (deposit, transfer, withdraw)\n- `MIN_DEPOSIT` - Minimum income requirement\n\nUpdate `permissions.json` with your role IDs for various permissions.\n\n### Deployment\nTo deploy slash commands to Discord:\n```bash\nnode deploy-commands.js\n```\n\n## Features\n\n### User Features\n- Account registration with validation\n- Balance checking\n- Fund transfers between users\n- Rank viewing\n- Support ticket system\n\n### Admin Features\n- Approve/reject registrations\n- User account management\n- Add balance to accounts\n- Freeze/unfreeze accounts\n- Promote users (change ranks)\n- Blacklist users\n- Edit transaction fees\n- Admin panel with permission-based access\n\n### Registration Flow\n1. User runs `/register` in registration channel\n2. Modal appears collecting: name, country, age, birth date, income\n3. User selects status (Ù…Ø¯Ù†ÙŠ/Ø¹ØµØ§Ø¨Ø©/ÙØµÙŠÙ„)\n4. If ÙØµÙŠÙ„ selected, user selects faction (Ø´Ø±Ø·Ø©/Ø¬ÙŠØ´/Ø·Ø¨)\n5. Request sent to admin channel for review\n6. Admin approves or rejects\n\n## Recent Changes\n- **2025-11-10**: Comprehensive logging system and data restore\n  - **Complete admin log coverage** - EVERYTHING now logs to the admin log channel:\n    - All admin actions (approve/reject, freeze, blacklist, edit info, fee changes)\n    - All financial transactions (admin deposits/withdrawals, user transfers/withdrawals)\n    - Data restore operations\n  - **Implemented blacklist functionality** - Admins can now blacklist users via /admin panel\n  - **Added /restore command** - Restore all user data from Google Sheets backup\n  - **Dual logging system**:\n    - Admin log channel: Text summaries of all activities\n    - Transaction log channel: Beautiful embeds for financial transactions only\n  - Fixed all interaction timeout errors by adding `deferUpdate()` and `deferReply()`\n  - Replaced all deprecated `ephemeral: true` with `flags: 64` across all files\n  - Updated event handler from `ready` to `clientReady` for Discord.js v14 compatibility\n  - Implemented Google Sheets integration with auto-sheet creation\n  - Added per-guild configuration system for multi-server support\n  - Added comprehensive Edit Info feature for admins\n  - Documented complete architecture showing how all components connect\n\n- **2025-11-06**: Project imported to Replit\n  - Configured workflow for bot execution\n  - Set up environment secrets (TOKEN, CLIENT_ID, GOOGLE_CLIENT_EMAIL, GOOGLE_PRIVATE_KEY, SHEET_ID)\n  - Installed dependencies (discord.js, dotenv, googleapis)\n  - Bot successfully running and connected to Discord\n\n## Current State\nThe bot is fully operational with all components properly connected:\n- âœ… All files integrated and working together\n- âœ… Google Sheets sync enabled (optional, gracefully degrades if unavailable)\n- âœ… Multi-server support via per-guild configuration\n- âœ… All interaction timeouts fixed\n- âœ… No deprecation warnings\n- âœ… Complete permission system active\n- âœ… Workflow \"discord-bot\" auto-starts with `node index.js`\n\n## Notes\n- Database is file-based using JSON storage in `database/users.json`\n- All UI messages are in Arabic\n- Bot uses Discord.js v14 with slash commands and modals\n- Permissions are role-based and configurable\n- Registration requires admin approval\n","size_bytes":8366},"commands/admin.js":{"content":"const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require(\"discord.js\");\nconst GC = require(\"../guildConfig\");\nconst fs = require(\"fs\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"admin\")\n    .setDescription(\"Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\")\n    .addUserOption(o => o.setName(\"target\").setDescription(\"Ù…Ø³ØªØ®Ø¯Ù…\").setRequired(false)),\n\n  async execute(interaction, ctx) {\n    if (!interaction.memberPermissions.has(\"Administrator\") && !GC.get(interaction.guildId).ADMIN_ROLE_ID) {\n      // we keep it simple; full permission checks happen on button press\n    }\n\n    const target = interaction.options.getUser(\"target\") || interaction.user;\n\n    if (!fs.existsSync(\"./database/users.json\")) fs.writeFileSync(\"./database/users.json\",\"{}\");\n    const users = JSON.parse(fs.readFileSync(\"./database/users.json\",\"utf8\"));\n    const u = users[target.id];\n\n    const g = GC.get(interaction.guildId);\n    const data = u || {\n      name: target.username, country:\"â€”\", age:\"â€”\", birth:\"â€”\", income:0, rank:g.ranks[0], balance:0, status:\"no-record\", kind:\"â€”\", faction:\"â€”\"\n    };\n\n    const embed = new EmbedBuilder()\n      .setColor(0x2b2d31).setTitle(\"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\").setThumbnail(target.displayAvatarURL({ size:256 }))\n      .setDescription(`${target} â€” \\n${target.tag}`)\n      .addFields(\n        { name:\"Ø§Ù„Ø§Ø³Ù…\", value:String(data.name), inline:true },\n        { name:\"Ø§Ù„Ø¨Ù„Ø¯\", value:String(data.country), inline:true },\n        { name:\"Ø§Ù„Ø¹Ù…Ø±\", value:String(data.age), inline:true },\n        { name:\"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯\", value:String(data.birth), inline:true },\n        { name:\"Ø§Ù„Ø¯Ø®Ù„\", value:String(data.income), inline:true },\n        { name:\"Ø§Ù„Ø±ØªØ¨Ø©\", value:String(data.rank), inline:true },\n        { name:\"Ø§Ù„Ø±ØµÙŠØ¯\", value:String(data.balance), inline:true },\n        { name:\"Ø§Ù„Ø­Ø§Ù„Ø©\", value:String(data.status), inline:true },\n        { name:\"Ø§Ù„Ù†ÙˆØ¹\", value:String(data.kind), inline:true },\n        { name:\"ÙØµÙŠÙ„\", value:String(data.faction), inline:true },\n        { name:\"ID\", value:target.id, inline:false }\n      );\n\n    const rows = [];\n    if (u && u.status === \"pending\") {\n      rows.push(new ActionRowBuilder().addComponents(\n        new ButtonBuilder().setCustomId(`approve_${target.id}`).setLabel(\"Ù…ÙˆØ§ÙÙ‚Ø©\").setStyle(ButtonStyle.Success),\n        new ButtonBuilder().setCustomId(`reject_${target.id}`).setLabel(\"Ø±ÙØ¶\").setStyle(ButtonStyle.Danger)\n      ));\n    }\n    rows.push(new ActionRowBuilder().addComponents(\n      new ButtonBuilder().setCustomId(`addBalance_${target.id}`).setLabel(\"Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯\").setStyle(ButtonStyle.Success),\n      new ButtonBuilder().setCustomId(`withdraw_${target.id}`).setLabel(\"Ø³Ø­Ø¨\").setStyle(ButtonStyle.Primary),\n      new ButtonBuilder().setCustomId(`promote_${target.id}`).setLabel(\"ØªØ±Ù‚ÙŠØ©\").setStyle(ButtonStyle.Secondary),\n      new ButtonBuilder().setCustomId(`editInfo_${target.id}`).setLabel(\"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª\").setStyle(ButtonStyle.Primary)\n    ));\n    rows.push(new ActionRowBuilder().addComponents(\n      new ButtonBuilder().setCustomId(`fees`).setLabel(\"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…\").setStyle(ButtonStyle.Secondary),\n      new ButtonBuilder().setCustomId(`${u?.frozen ? \"unfreeze\":\"freeze\"}_${target.id}`).setLabel(u?.frozen ? \"Ø¥Ù„ØºØ§Ø¡ ØªØ¬Ù…ÙŠØ¯\":\"ØªØ¬Ù…ÙŠØ¯\").setStyle(ButtonStyle.Secondary),\n      new ButtonBuilder().setCustomId(`blacklist_${target.id}`).setLabel(\"Ù‚Ø§Ø¦Ù…Ø© Ø³ÙˆØ¯Ø§Ø¡\").setStyle(ButtonStyle.Danger)\n    ));\n\n    await interaction.reply({ embeds:[embed], components:rows, flags: 64 });\n  }\n};\n","size_bytes":3692},"commands/rank.js":{"content":"const { SlashCommandBuilder, PermissionFlagsBits } = require(\"discord.js\");\nconst fs = require(\"fs\");\nconst GC = require(\"../guildConfig\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"rank\")\n    .setDescription(\"ØªØ¹ÙŠÙŠÙ† Ø±ØªØ¨Ø© Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ù…Ø´Ø±Ù)\")\n    .addUserOption(o => o.setName(\"user\").setDescription(\"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\").setRequired(true))\n    .addStringOption(o => o.setName(\"rank\").setDescription(\"Ø±ØªØ¨Ø©\").setRequired(true)),\n\n  async execute(interaction) {\n    if (!interaction.memberPermissions.has(PermissionFlagsBits.Administrator)) {\n      return interaction.reply({ content:\"Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.\", flags: 64 });\n    }\n\n    const target = interaction.options.getUser(\"user\");\n    const r = interaction.options.getString(\"rank\");\n\n    if (!fs.existsSync(\"./database/users.json\")) fs.writeFileSync(\"./database/users.json\",\"{}\");\n    const users = JSON.parse(fs.readFileSync(\"./database/users.json\",\"utf8\"));\n\n    if (!users[target.id]) users[target.id] = {\n      name: target.username, country:\"\", age:null, birth:\"\", income:0, rank:r, balance:0, status:\"approved\", frozen:false\n    };\n    else users[target.id].rank = r;\n\n    fs.writeFileSync(\"./database/users.json\", JSON.stringify(users,null,2));\n    return interaction.reply({ content:`ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø±ØªØ¨Ø© <@${target.id}> Ø¥Ù„Ù‰ **${r}**.`, flags: 64 });\n  }\n};\n","size_bytes":1389},"commands/register.js":{"content":"const {\n  SlashCommandBuilder,\n  ModalBuilder,\n  TextInputBuilder,\n  TextInputStyle,\n  ActionRowBuilder,\n} = require(\"discord.js\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"register\")\n    .setDescription(\"Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†ÙƒÙŠ\"),\n\n  async execute(interaction, { gconf }) {\n    const g = gconf(interaction.guildId);\n    if (g.REGISTER_CHANNEL_ID && interaction.channelId !== g.REGISTER_CHANNEL_ID) {\n      return interaction.reply({\n        content: `ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙÙ‚Ø· ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ <#${g.REGISTER_CHANNEL_ID}>.`,\n        flags: 64,\n      });\n    }\n\n    const modal = new ModalBuilder().setCustomId(\"registerModal\").setTitle(\"ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†ÙƒÙŠ\");\n    const name = new TextInputBuilder().setCustomId(\"name\").setLabel(\"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„\").setStyle(TextInputStyle.Short).setRequired(true);\n    const country = new TextInputBuilder().setCustomId(\"country\").setLabel(\"Ø§Ù„Ø¯ÙˆÙ„Ø©\").setStyle(TextInputStyle.Short).setRequired(true);\n    const age = new TextInputBuilder().setCustomId(\"age\").setLabel(\"Ø§Ù„Ø¹Ù…Ø± (16â€“65)\").setStyle(TextInputStyle.Short).setRequired(true);\n    const birth = new TextInputBuilder().setCustomId(\"birth\").setLabel(\"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (YYYY-MM-DD)\").setStyle(TextInputStyle.Short).setRequired(true);\n    const income = new TextInputBuilder().setCustomId(\"income\").setLabel(`Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ`).setStyle(TextInputStyle.Short).setRequired(true);\n\n    modal.addComponents(\n      new ActionRowBuilder().addComponents(name),\n      new ActionRowBuilder().addComponents(country),\n      new ActionRowBuilder().addComponents(age),\n      new ActionRowBuilder().addComponents(birth),\n      new ActionRowBuilder().addComponents(income)\n    );\n\n    await interaction.showModal(modal);\n  },\n};\n","size_bytes":1814},"commands/account.js":{"content":"// commands/account.js â€” Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ\nconst { SlashCommandBuilder, EmbedBuilder } = require(\"discord.js\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"account\")\n    .setDescription(\"Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ\"),\n\n  async execute(interaction, ctx) {\n    try {\n      const users = ctx.users();                 // â† Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù…Ù„ index.js Ø§Ù„Ø¢Ù…Ù†\n      const user  = users[interaction.user.id];\n\n      if (!user) {\n        return interaction.reply({\n          content: \"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨Ùƒ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… `/register`.\",\n          flags: 64, // ÙÙŠ v14 Ù„Ø§ Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø°ÙŠØ±\n        });\n      }\n\n      const embed = new EmbedBuilder()\n        .setColor(0x0099ff)\n        .setTitle(\"ğŸ’³ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ\")\n        .setThumbnail(interaction.user.displayAvatarURL({ size: 256 }))\n        .addFields(\n          { name: \"Ø§Ù„Ø§Ø³Ù…\", value: String(user.name ?? \"ØºÙŠØ± Ù…Ø­Ø¯Ø¯\"), inline: true },\n          { name: \"Ø§Ù„Ø¹Ù…Ø±\", value: String(user.age ?? \"â€”\"), inline: true },\n          { name: \"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯\", value: String(user.birth ?? \"â€”\"), inline: true },\n          { name: \"Ø§Ù„Ø¯ÙˆÙ„Ø©\", value: String(user.country ?? \"â€”\"), inline: true },\n          { name: \"Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ\", value: String(user.income ?? \"0\"), inline: true },\n          { name: \"Ø§Ù„Ø±ØªØ¨Ø©\", value: String(user.rank ?? \"â€”\"), inline: true },\n          { name: \"Ø§Ù„Ø±ØµÙŠØ¯\", value: String(user.balance ?? 0), inline: true },\n          { name: \"Ø§Ù„Ø­Ø§Ù„Ø©\", value: String(user.status ?? \"â€”\"), inline: true },\n          { name: \"Ø§Ù„ÙØµÙŠÙ„\", value: String(user.faction ?? \"â€”\"), inline: true },\n          { name: \"Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\", value: String(interaction.user.id), inline: false }\n        )\n        .setFooter({ text: \"ğŸ¦ Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹\" });\n\n      await interaction.reply({ embeds: [embed], flags: 64 });\n    } catch (error) {\n      console.error(\"account error:\", error);\n      if (!interaction.replied) {\n        await interaction.reply({\n          content: \"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨.\",\n          flags: 64,\n        });\n      }\n    }\n  },\n};\n","size_bytes":2278},"deploy-commands.js":{"content":"const fs = require(\"fs\");\nconst path = require(\"path\");\nconst { REST, Routes } = require(\"discord.js\");\nrequire(\"dotenv\").config();\n\nconst TOKEN   = process.env.TOKEN;\nconst APP_ID  = process.env.APP_ID;\nconst GUILD_ID = process.env.GUILD_ID;\n\nconst isGlobal = process.argv.includes(\"--global\");\nconst isPurge = process.argv.includes(\"--purge\");\n\nif (!TOKEN || !APP_ID) {\n  console.error(\"âŒ Missing TOKEN / APP_ID in .env\");\n  process.exit(1);\n}\n\nif (!isGlobal && !GUILD_ID) {\n  console.error(\"âŒ Missing GUILD_ID in .env (required for guild-specific deployment)\");\n  console.error(\"ğŸ’¡ Use --global flag to deploy commands globally instead\");\n  process.exit(1);\n}\n\nconst rest = new REST({ version: \"10\" }).setToken(TOKEN);\nconst commandsDir = path.join(__dirname, \"commands\");\nconst files = fs.readdirSync(commandsDir).filter(f => f.endsWith(\".js\"));\nlet body = [];\n\nif (!isPurge) {\n  for (const f of files) {\n    const mod = require(path.join(commandsDir, f));\n    if (mod?.data) body.push(mod.data.toJSON());\n  }\n}\n\n(async () => {\n  if (isPurge) {\n    if (isGlobal) {\n      await rest.put(Routes.applicationCommands(APP_ID), { body: [] });\n      console.log(\"ğŸ—‘ï¸ Purged all global commands\");\n    } else {\n      await rest.put(Routes.applicationGuildCommands(APP_ID, GUILD_ID), { body: [] });\n      console.log(`ğŸ—‘ï¸ Purged all commands from guild ${GUILD_ID}`);\n    }\n  } else {\n    if (isGlobal) {\n      await rest.put(Routes.applicationCommands(APP_ID), { body });\n      console.log(`âœ… Deployed ${body.length} commands globally`);\n      console.log(\"âš ï¸ Note: Global commands can take up to 1 hour to appear in all servers\");\n    } else {\n      await rest.put(Routes.applicationGuildCommands(APP_ID, GUILD_ID), { body });\n      console.log(`âœ… Deployed ${body.length} commands to guild ${GUILD_ID}`);\n    }\n  }\n})();\n","size_bytes":1840},"commands/support.js":{"content":"const { SlashCommandBuilder, ModalBuilder, TextInputBuilder, TextInputStyle, ActionRowBuilder } = require(\"discord.js\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder().setName(\"support\").setDescription(\"Contact bank support\"),\n\n  async execute(interaction) {\n    const modal = new ModalBuilder().setCustomId(\"supportModal\").setTitle(\"Support Request\");\n    const subject = new TextInputBuilder().setCustomId(\"subj\").setLabel(\"Subject\").setStyle(TextInputStyle.Short).setRequired(true);\n    const body = new TextInputBuilder().setCustomId(\"body\").setLabel(\"Describe your issue\").setStyle(TextInputStyle.Paragraph).setRequired(true);\n    modal.addComponents(new ActionRowBuilder().addComponents(subject), new ActionRowBuilder().addComponents(body));\n    await interaction.showModal(modal);\n  },\n};\n\n","size_bytes":804},"commands/transfer.js":{"content":"const { SlashCommandBuilder, EmbedBuilder } = require(\"discord.js\");\nconst GC = require(\"../guildConfig\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"transfer\")\n    .setDescription(\"ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯ Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…\")\n    .addUserOption(o => o.setName(\"user\").setDescription(\"Ø§Ù„Ù…Ø³ØªÙ„Ù…\").setRequired(true))\n    .addIntegerOption(o => o.setName(\"amount\").setDescription(\"Ø§Ù„Ù…Ø¨Ù„Øº\").setRequired(true)),\n\n  async execute(interaction, { gconf, users, saveUsers, pushTx, logTransaction, pushLog }) {\n    const g = gconf();\n    const from = interaction.user.id;\n    const toUser = interaction.options.getUser(\"user\");\n    const to = toUser.id;\n    const amount = interaction.options.getInteger(\"amount\");\n\n    const U = users();\n    const A = U[from], B = U[to];\n    if (!A || !B) return interaction.reply({ content:\"ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø·Ø±ÙØ§Ù† Ø­Ø³Ø§Ø¨Ù‹Ø§.\", flags: 64 });\n    if (A.frozen) return interaction.reply({ content:\"Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯.\", flags: 64 });\n    if (amount <= 0) return interaction.reply({ content:\"Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­.\", flags: 64 });\n\n    const fee = Math.floor((amount*(g.fees.TRANSFER_FEE||0))/100);\n    const total = amount + fee;\n    if ((A.balance||0) < total) return interaction.reply({ content:\"Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ.\", flags: 64 });\n\n    A.balance -= total;\n    B.balance = (B.balance||0) + amount;\n    saveUsers(U, interaction.guild);\n    pushTx({ type:\"transfer\", guildId: interaction.guildId, from, to, amount, fee });\n\n    // Log to transaction channel\n    const embed = new EmbedBuilder()\n      .setColor(0x3498db)\n      .setTitle(\"ğŸ’¸ ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯\")\n      .addFields(\n        { name: \"Ù…Ù†\", value: `<@${from}> (${A.name || \"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ\"})`, inline: true },\n        { name: \"Ø¥Ù„Ù‰\", value: `<@${to}> (${B.name || \"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ\"})`, inline: true },\n        { name: \"Ø§Ù„Ù…Ø¨Ù„Øº\", value: `${amount}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø±Ø³ÙˆÙ…\", value: `${fee}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\", value: `${total}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ\", value: `${A.balance}${g.CURRENCY_SYMBOL}`, inline: true }\n      )\n      .setTimestamp();\n    \n    logTransaction(interaction.guildId, embed);\n    await pushLog(interaction.guildId, `ğŸ’¸ <@${from}> Ø­ÙˆÙ„ ${amount}${g.CURRENCY_SYMBOL} Ø¥Ù„Ù‰ <@${to}> (Ø±Ø³ÙˆÙ… ${fee}${g.CURRENCY_SYMBOL})`);\n\n    return interaction.reply({ content:`ØªÙ… ØªØ­ÙˆÙŠÙ„ ${amount}${g.CURRENCY_SYMBOL} Ø¥Ù„Ù‰ <@${to}> (Ø±Ø³ÙˆÙ… ${fee}).`, flags: 64 });\n  }\n};\n","size_bytes":2610},"guildConfig.js":{"content":"// guildConfig.js â€” per-guild settings persisted to guildConfigs.json\nconst fs = require(\"fs\");\nconst PATH = \"./guildConfigs.json\";\n\nfunction ensure() { if (!fs.existsSync(PATH)) fs.writeFileSync(PATH, \"{}\"); }\nfunction readAll() { ensure(); return JSON.parse(fs.readFileSync(PATH, \"utf8\") || \"{}\"); }\nfunction writeAll(obj) { fs.writeFileSync(PATH, JSON.stringify(obj, null, 2)); }\n\n// Defaults come from config.json if present\nfunction baseDefaults() {\n  try {\n    const c = require(\"./config.json\");\n    return {\n      CURRENCY_SYMBOL: c.CURRENCY_SYMBOL || \"$\",\n      MIN_DEPOSIT: c.MIN_DEPOSIT ?? 0,\n      ranks: c.ranks || [\"Bronze\",\"Silver\",\"Gold\"],\n      fees: c.fees || { DEPOSIT_FEE: 0, TRANSFER_FEE: 0, WITHDRAW_FEE: 0 },\n      // the below are empty until /setup\n      REGISTER_CHANNEL_ID: c.REGISTER_CHANNEL_ID || \"\",\n      ADMIN_CHANNEL_ID: c.ADMIN_CHANNEL_ID || \"\",\n      ADMIN_LOG_CHANNEL_ID: c.ADMIN_LOG_CHANNEL_ID || \"\",\n      ADMIN_ROLE_ID: c.ADMIN_ROLE_ID || \"\",\n      REGLIST_CHANNEL_ID: \"\",\n      TRANSACTION_LOG_CHANNEL_ID: \"\",\n    };\n  } catch {\n    return {\n      CURRENCY_SYMBOL: \"$\",\n      MIN_DEPOSIT: 0,\n      ranks: [\"Bronze\",\"Silver\",\"Gold\"],\n      fees: { DEPOSIT_FEE: 0, TRANSFER_FEE: 0, WITHDRAW_FEE: 0 },\n      REGISTER_CHANNEL_ID: \"\",\n      ADMIN_CHANNEL_ID: \"\",\n      ADMIN_LOG_CHANNEL_ID: \"\",\n      ADMIN_ROLE_ID: \"\",\n      REGLIST_CHANNEL_ID: \"\",\n      TRANSACTION_LOG_CHANNEL_ID: \"\",\n    };\n  }\n}\n\nfunction get(guildId) {\n  const all = readAll();\n  const d = baseDefaults();\n  return { ...d, ...(all[guildId] || {}) };\n}\nfunction set(guildId, patch) {\n  const all = readAll();\n  all[guildId] = { ...(all[guildId] || {}), ...patch };\n  writeAll(all);\n  return get(guildId);\n}\nfunction patch(guildId, patchObj) {\n  return set(guildId, patchObj);\n}\n\nmodule.exports = { get, set, patch };\n","size_bytes":1826},"sheets.js":{"content":"// sheets.js\nconst { google } = require('googleapis');\n\nlet sheets, sheetId;\nlet initialized = false;\n\nasync function init() {\n  if (initialized) return;\n  const auth = new google.auth.JWT({\n    email: process.env.GOOGLE_CLIENT_EMAIL,\n    key: (process.env.GOOGLE_PRIVATE_KEY || '').replace(/\\\\n/g, '\\n'),\n    scopes: ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']\n  });\n  sheets = google.sheets({ version: 'v4', auth });\n  sheetId = process.env.SHEET_ID;\n  initialized = true;\n}\n\nasync function ensureUsersSheet() {\n  await init();\n  \n  // Check if \"Users\" sheet exists\n  try {\n    const { data } = await sheets.spreadsheets.get({ spreadsheetId: sheetId });\n    const sheetNames = data.sheets.map(s => s.properties.title);\n    \n    if (!sheetNames.includes('Users')) {\n      console.log('Creating \"Users\" sheet...');\n      await sheets.spreadsheets.batchUpdate({\n        spreadsheetId: sheetId,\n        requestBody: {\n          requests: [{\n            addSheet: {\n              properties: {\n                title: 'Users'\n              }\n            }\n          }]\n        }\n      });\n      console.log('âœ… \"Users\" sheet created');\n    }\n  } catch (e) {\n    console.error('Error ensuring Users sheet:', e.message);\n    throw e;\n  }\n}\n\nasync function ensureHeader() {\n  await init();\n  await ensureUsersSheet();\n  \n  // Read first row\n  try {\n    const { data } = await sheets.spreadsheets.values.get({\n      spreadsheetId: sheetId,\n      range: 'Users!A1:M1',\n      valueRenderOption: 'UNFORMATTED_VALUE',\n    });\n    const need = ['id','name','country','age','birth','income','rank','balance','status','kind','faction','createdAt','updatedAt'];\n    const have = (data.values && data.values[0]) || [];\n    if (need.every((h, i) => have[i] === h)) return;\n\n    await sheets.spreadsheets.values.update({\n      spreadsheetId: sheetId,\n      range: 'Users!A1:M1',\n      valueInputOption: 'RAW',\n      requestBody: { values: [need] },\n    });\n  } catch (e) {\n    console.error('Error setting header:', e.message);\n    throw e;\n  }\n}\n\nasync function upsertUser(row) {\n  await init();\n  await ensureHeader();\n\n  // Find existing row by id\n  const { data } = await sheets.spreadsheets.values.get({\n    spreadsheetId: sheetId,\n    range: 'Users!A2:A',\n    valueRenderOption: 'UNFORMATTED_VALUE',\n  });\n\n  const ids = (data.values || []).map(v => String(v[0]));\n  const idx = ids.indexOf(String(row.id));\n\n  const values = [[\n    row.id, row.name || '', row.country || '', row.age ?? '', row.birth || '',\n    row.income ?? 0, row.rank || '', row.balance ?? 0, row.status || '',\n    row.kind || '', row.faction || '', row.createdAt || '', row.updatedAt || ''\n  ]];\n\n  if (idx === -1) {\n    // append\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: sheetId,\n      range: 'Users!A2',\n      valueInputOption: 'RAW',\n      requestBody: { values }\n    });\n  } else {\n    // update in place (row number = idx+2)\n    const range = `Users!A${idx+2}:M${idx+2}`;\n    await sheets.spreadsheets.values.update({\n      spreadsheetId: sheetId, range,\n      valueInputOption: 'RAW', requestBody: { values }\n    });\n  }\n}\n\nasync function syncUsers(allUsersObj) {\n  await init();\n  await ensureHeader();\n\n  const rows = Object.entries(allUsersObj).map(([id,u]) => ([\n    id,\n    u.name || '', u.country || '', u.age ?? '', u.birth || '',\n    u.income ?? 0, u.rank || '', u.balance ?? 0, u.status || '',\n    u.kind || '', u.faction || '',\n    u.createdAt || '', u.updatedAt || ''\n  ]));\n\n  if (!rows.length) return;\n\n  await sheets.spreadsheets.values.clear({\n    spreadsheetId: sheetId, range: 'Users!A2:M'\n  });\n  await sheets.spreadsheets.values.append({\n    spreadsheetId: sheetId, range: 'Users!A2',\n    valueInputOption: 'RAW',\n    requestBody: { values: rows }\n  });\n}\n\nasync function logTx(entry) {\n  try {\n    await init();\n    const { data } = await sheets.spreadsheets.get({ spreadsheetId: sheetId });\n    const sheetNames = data.sheets.map(s => s.properties.title);\n    \n    if (!sheetNames.includes('Transactions')) {\n      await sheets.spreadsheets.batchUpdate({\n        spreadsheetId: sheetId,\n        requestBody: {\n          requests: [{\n            addSheet: {\n              properties: {\n                title: 'Transactions'\n              }\n            }\n          }]\n        }\n      });\n    }\n    \n    const header = ['timestamp', 'type', 'from', 'to', 'amount', 'reason', 'admin'];\n    try {\n      const { data: headerData } = await sheets.spreadsheets.values.get({\n        spreadsheetId: sheetId,\n        range: 'Transactions!A1:G1',\n      });\n      if (!headerData.values || headerData.values.length === 0) {\n        await sheets.spreadsheets.values.update({\n          spreadsheetId: sheetId,\n          range: 'Transactions!A1:G1',\n          valueInputOption: 'RAW',\n          requestBody: { values: [header] },\n        });\n      }\n    } catch (e) {}\n    \n    await sheets.spreadsheets.values.append({\n      spreadsheetId: sheetId,\n      range: 'Transactions!A2',\n      valueInputOption: 'RAW',\n      requestBody: {\n        values: [[\n          entry.ts || new Date().toISOString(),\n          entry.type || '',\n          entry.from || '',\n          entry.to || '',\n          entry.amount || 0,\n          entry.reason || '',\n          entry.admin || ''\n        ]]\n      }\n    });\n  } catch (e) {\n    console.error('Error logging transaction to sheets:', e.message);\n  }\n}\n\nasync function onUserChange(userData) {\n  try {\n    if (!userData || !userData.id) return;\n    await upsertUser(userData);\n  } catch (e) {\n    console.error('Error on user change:', e.message);\n  }\n}\n\nasync function restoreUsersFromSheet() {\n  await init();\n  await ensureHeader();\n\n  try {\n    const { data } = await sheets.spreadsheets.values.get({\n      spreadsheetId: sheetId,\n      range: 'Users!A2:M',\n      valueRenderOption: 'UNFORMATTED_VALUE',\n    });\n\n    if (!data.values || data.values.length === 0) {\n      return { success: false, message: 'No users found in Google Sheets', count: 0 };\n    }\n\n    const users = {};\n    data.values.forEach(row => {\n      const [id, name, country, age, birth, income, rank, balance, status, kind, faction, createdAt, updatedAt] = row;\n      if (id) {\n        users[String(id)] = {\n          id: String(id),\n          name: name || '',\n          country: country || '',\n          age: age || 0,\n          birth: birth || '',\n          income: income || 0,\n          rank: rank || '',\n          balance: balance || 0,\n          status: status || '',\n          kind: kind || '',\n          faction: faction || '',\n          createdAt: createdAt || '',\n          updatedAt: updatedAt || new Date().toISOString(),\n          _daily: {}\n        };\n      }\n    });\n\n    return { success: true, users, count: Object.keys(users).length };\n  } catch (e) {\n    console.error('Error restoring users from sheets:', e.message);\n    return { success: false, message: e.message, count: 0 };\n  }\n}\n\nmodule.exports = { upsertUser, syncUsers, logTx, onUserChange, restoreUsersFromSheet };\n","size_bytes":7048},"commands/setup.js":{"content":"// commands/setup.js â€” admin-only per-guild setup\nconst { SlashCommandBuilder, PermissionFlagsBits } = require(\"discord.js\");\nconst GC = require(\"../guildConfig\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"setup\")\n    .setDescription(\"ØªÙ‡ÙŠØ¦Ø© Ù‚Ù†ÙˆØ§Øª ÙˆØ±ÙˆÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ±\")\n    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)\n    .addChannelOption(o => o.setName(\"register_channel\").setDescription(\"Ù‚Ù†Ø§Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\").setRequired(true))\n    .addChannelOption(o => o.setName(\"review_channel\").setDescription(\"Ù‚Ù†Ø§Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª\").setRequired(true))\n    .addChannelOption(o => o.setName(\"reglist_channel\").setDescription(\"Ù‚Ù†Ø§Ø© Ù…Ù„Ø®Øµ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„\").setRequired(false))\n    .addChannelOption(o => o.setName(\"log_channel\").setDescription(\"Ù‚Ù†Ø§Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)\").setRequired(false))\n    .addChannelOption(o => o.setName(\"transaction_log_channel\").setDescription(\"Ù‚Ù†Ø§Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)\").setRequired(false))\n    .addRoleOption(o => o.setName(\"admin_role\").setDescription(\"Ø±ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)\").setRequired(false)),\n\n  async execute(interaction) {\n    const gid = interaction.guildId;\n\n    const register = interaction.options.getChannel(\"register_channel\", true);\n    const review   = interaction.options.getChannel(\"review_channel\", true);\n    const reglist  = interaction.options.getChannel(\"reglist_channel\") || null;\n    const logs     = interaction.options.getChannel(\"log_channel\") || null;\n    const txLogs   = interaction.options.getChannel(\"transaction_log_channel\") || null;\n    const admin    = interaction.options.getRole(\"admin_role\") || null;\n\n    GC.set(gid, {\n      REGISTER_CHANNEL_ID: register.id,\n      ADMIN_CHANNEL_ID: review.id,\n      REGLIST_CHANNEL_ID: reglist?.id || \"\",\n      ADMIN_LOG_CHANNEL_ID: logs?.id || \"\",\n      TRANSACTION_LOG_CHANNEL_ID: txLogs?.id || \"\",\n      ADMIN_ROLE_ID: admin?.id || \"\",\n    });\n\n    await interaction.reply({\n      content:\n        `âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸:\\nâ€¢ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: <#${register.id}>\\nâ€¢ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <#${review.id}>` +\n        (reglist ? `\\nâ€¢ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª: <#${reglist.id}>` : \"\") +\n        (logs ? `\\nâ€¢ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©: <#${logs.id}>` : \"\") +\n        (txLogs ? `\\nâ€¢ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: <#${txLogs.id}>` : \"\") +\n        (admin ? `\\nâ€¢ Ø±ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: <@&${admin.id}>` : \"\"),\n      flags: 64,\n    });\n  },\n};\n","size_bytes":2553},"index.js":{"content":"// index.js â€” Arabic bank bot: register flow + admin actions (+ withdraw) + per-guild config\n\nrequire(\"dotenv\").config();\nconst fs = require(\"fs\");\nconst {\n  Client,\n  GatewayIntentBits,\n  Collection,\n  ActionRowBuilder,\n  ButtonBuilder,\n  ButtonStyle,\n  ModalBuilder,\n  TextInputBuilder,\n  TextInputStyle,\n  EmbedBuilder,\n  PermissionFlagsBits,\n  StringSelectMenuBuilder,\n  ChannelType,\n} = require(\"discord.js\");\n\n// ===== app modules / local files =====\nconst permsMap = require(\"./permissions.json\");\nconst GC = require(\"./guildConfig\"); // per-guild config accessor (get/set/patch)\nlet Sheets; try { Sheets = require(\"./sheets\"); } catch { Sheets = { syncUsers: async () => {}, logTx: async () => {}, onUserChange: async () => {} }; }\n\n// ===== Discord client =====\nconst client = new Client({\n  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent],\n});\n\nclient.commands = new Collection();\nfor (const f of fs.readdirSync(\"./commands\").filter(x => x.endsWith(\".js\"))) {\n  const mod = require(`./commands/${f}`);\n  if (mod?.data?.name) client.commands.set(mod.data.name, mod);\n}\n\n// ===== util: file & persistence =====\nfunction ensureFile(path) {\n  const dir = path.split(\"/\").slice(0, -1).join(\"/\");\n  if (dir && !fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });\n  if (!fs.existsSync(path)) fs.writeFileSync(path, path.endsWith(\".json\") ? \"{}\" : \"\");\n}\n\nfunction loadUsers() {\n  ensureFile(\"./database/users.json\");\n  return JSON.parse(fs.readFileSync(\"./database/users.json\", \"utf8\") || \"{}\");\n}\nfunction saveUsers(users) {\n  ensureFile(\"./database/users.json\");\n  fs.writeFileSync(\"./database/users.json\", JSON.stringify(users, null, 2));\n  // sync to Google Sheet if available\n  Promise.resolve(Sheets.syncUsers(users)).catch(() => {});\n}\n\nfunction loadTx() {\n  ensureFile(\"./database/transactions.json\");\n  try { return JSON.parse(fs.readFileSync(\"./database/transactions.json\", \"utf8\") || \"[]\"); }\n  catch { return []; }\n}\nfunction saveTx(arr) {\n  ensureFile(\"./database/transactions.json\");\n  fs.writeFileSync(\"./database/transactions.json\", JSON.stringify(arr, null, 2));\n}\nfunction pushTx(entry) {\n  const arr = loadTx();\n  arr.push({ ts: new Date().toISOString(), ...entry });\n  saveTx(arr);\n  // sheet log if provided\n  Promise.resolve(Sheets.logTx(entry)).catch(() => {});\n}\n\n// ===== helpers: perms & logs =====\nfunction hasAnyRoleId(member, ids = []) {\n  if (!ids?.length) return false;\n  return member.roles.cache.some(r => ids.includes(r.id));\n}\nfunction hasPermission(member, key, gconf) {\n  return (\n    member.permissions?.has?.(PermissionFlagsBits.Administrator) ||\n    (gconf.ADMIN_ROLE_ID && member.roles.cache.has(gconf.ADMIN_ROLE_ID)) ||\n    hasAnyRoleId(member, permsMap[key] || [])\n  );\n}\n\nasync function pushLog(guildId, content) {\n  const gconf = GC.get(guildId);\n  if (!gconf.ADMIN_LOG_CHANNEL_ID) return;\n  try {\n    const ch =\n      client.channels.cache.get(gconf.ADMIN_LOG_CHANNEL_ID) ||\n      (await client.channels.fetch(gconf.ADMIN_LOG_CHANNEL_ID).catch(() => null));\n    if (ch) ch.send(String(content));\n  } catch {}\n}\n\n// Transaction log to dedicated channel\nasync function logTransaction(guildId, embed) {\n  const gconf = GC.get(guildId);\n  if (!gconf.TRANSACTION_LOG_CHANNEL_ID) return;\n  try {\n    const ch =\n      client.channels.cache.get(gconf.TRANSACTION_LOG_CHANNEL_ID) ||\n      (await client.channels.fetch(gconf.TRANSACTION_LOG_CHANNEL_ID).catch(() => null));\n    if (ch) {\n      if (typeof embed === 'string') {\n        ch.send(embed);\n      } else {\n        ch.send({ embeds: [embed] });\n      }\n    }\n  } catch {}\n}\n\n// Small summary to the reglist channel (optional)\nasync function updateRegList(guildId) {\n  const gconf = GC.get(guildId);\n  if (!gconf.REGLIST_CHANNEL_ID) return;\n\n  const users = loadUsers();\n  let pending = 0, approved = 0, rejected = 0, blacklisted = 0;\n  for (const id of Object.keys(users)) {\n    const st = (users[id].status || \"\").toLowerCase();\n    if (st === \"pending\") pending++;\n    else if (st === \"approved\") approved++;\n    else if (st === \"rejected\") rejected++;\n    else if (st === \"blacklisted\") blacklisted++;\n  }\n\n  try {\n    const ch =\n      client.channels.cache.get(gconf.REGLIST_CHANNEL_ID) ||\n      (await client.channels.fetch(gconf.REGLIST_CHANNEL_ID).catch(() => null));\n    if (!ch) return;\n\n    const embed = new EmbedBuilder()\n      .setColor(0x2b2d31)\n      .setTitle(\"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª\")\n      .setDescription(\"Ù…Ù„Ø®Øµ Ø­Ø§Ù„Ø§Øª Ø·Ù„Ø¨Ø§Øª ÙØªØ­ Ø§Ù„Ø­Ø³Ø§Ø¨\")\n      .addFields(\n        { name: \"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\", value: String(pending), inline: true },\n        { name: \"Ù…Ù‚Ø¨ÙˆÙ„\", value: String(approved), inline: true },\n        { name: \"Ù…Ø±ÙÙˆØ¶\", value: String(rejected), inline: true },\n        { name: \"Ù‚Ø§Ø¦Ù…Ø© Ø³ÙˆØ¯Ø§Ø¡\", value: String(blacklisted), inline: true },\n      )\n      .setFooter({ text: new Date().toLocaleString() });\n\n    await ch.send({ embeds: [embed] });\n  } catch {}\n}\n\n// ===== register draft between modal & selects =====\nconst regDraft = new Map();\n\n// ===== events =====\nclient.once(\"clientReady\", () => {\n  console.log(`ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${client.user.tag}`);\n});\n\nclient.on(\"interactionCreate\", async (interaction) => {\n  try {\n    const gconf = GC.get(interaction.guildId || \"\");\n\n    // Slash commands\n    if (interaction.isChatInputCommand()) {\n      const cmd = client.commands.get(interaction.commandName);\n      if (!cmd) return;\n\n      // pass helpers into commands\n      await cmd.execute(interaction, {\n        gconf: (gid) => GC.get(gid || interaction.guildId),\n        users: loadUsers,\n        saveUsers,\n        updateRegList,\n        pushTx,\n        pushLog,\n        logTransaction,\n      });\n      return;\n    }\n\n    // ====== Select menus for registration ======\n    if (interaction.isStringSelectMenu() && interaction.customId === \"reg_status_after\") {\n      const d = regDraft.get(interaction.user.id) || {};\n      d.kind = interaction.values?.[0];\n      regDraft.set(interaction.user.id, d);\n\n      // status chosen -> remove status menu; if ÙØµÙŠÙ„ then show faction select, otherwise finalize\n      if (d.kind === \"ÙØµÙŠÙ„\") {\n        const factionRow = new ActionRowBuilder().addComponents(\n          new StringSelectMenuBuilder()\n            .setCustomId(\"reg_faction_after\")\n            .setPlaceholder(\"Ø§Ø®ØªØ± Ø§Ù„ÙØµÙŠÙ„\")\n            .addOptions(\n              { label: \"Ø´Ø±Ø·Ø©\", value: \"Ø´Ø±Ø·Ø©\" },\n              { label: \"Ø¬ÙŠØ´\", value: \"Ø¬ÙŠØ´\" },\n              { label: \"Ø·Ø¨\", value: \"Ø·Ø¨\" },\n            )\n        );\n        // keep submit fallback row if exists\n        const submitRow = interaction.message.components.find(r =>\n          r.components?.some(c => c.customId === \"reg_submit_after\")\n        );\n        const rows = submitRow ? [factionRow, submitRow] : [factionRow];\n        return interaction.update({ components: rows });\n      }\n\n      // Not a faction -> finalize\n      return finalizeRegistration(interaction, d);\n    }\n\n    if (interaction.isStringSelectMenu() && interaction.customId === \"reg_faction_after\") {\n      const d = regDraft.get(interaction.user.id) || {};\n      d.faction = interaction.values?.[0] || null;\n      regDraft.set(interaction.user.id, d);\n      return finalizeRegistration(interaction, d);\n    }\n\n    // Fallback register submit button\n    if (interaction.isButton() && interaction.customId === \"reg_submit_after\") {\n      const d = regDraft.get(interaction.user.id);\n      if (!d)\n        return interaction.reply({ content: \"Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ /register.\", flags: 64 });\n      return finalizeRegistration(interaction, d);\n    }\n\n    // ====== Admin buttons ======\n    if (interaction.isButton()) {\n      const [action, userId, extra] = interaction.customId.split(\"_\");\n      const users = loadUsers();\n      const target = users[userId];\n\n      // Approve/Reject\n      if (action === \"approve\" || action === \"reject\") {\n        const permKey = action === \"approve\" ? \"approve\" : \"reject\";\n        if (!hasPermission(interaction.member, permKey, gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n        if (target.status !== \"pending\")\n          return interaction.reply({ content: `Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ **${target.status}**.`, flags: 64 });\n\n        // Defer to prevent timeout\n        await interaction.deferUpdate();\n\n        const approved = (action === \"approve\");\n        target.status = approved ? \"approved\" : \"rejected\";\n        saveUsers(users);\n        await Sheets.onUserChange?.({ id: userId, ...target }).catch(() => {});\n        await updateRegList(interaction.guildId);\n\n        await pushLog(interaction.guildId, `${approved ? \"âœ…\" : \"â›”\"} ${interaction.user.username} ${approved ? \"Ù‚Ø¨Ù„\" : \"Ø±ÙØ¶\"} Ø­Ø³Ø§Ø¨ <@${userId}>`);\n\n        await interaction.editReply({ content: `${approved ? \"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\" : \"â›” ØªÙ… Ø§Ù„Ø±ÙØ¶\"} Ø¹Ù„Ù‰ Ø·Ù„Ø¨ **${target.name}** (${userId})`, components: [] });\n        return;\n      }\n\n      // Add balance\n      if (action === \"addBalance\") {\n        if (!hasPermission(interaction.member, \"addBalance\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n\n        const modal = new ModalBuilder().setCustomId(`addBalanceModal_${userId}`).setTitle(\"Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯\");\n        const amountInput = new TextInputBuilder()\n          .setCustomId(\"amount\")\n          .setLabel(\"Ø§Ù„Ù…Ø¨Ù„Øº\")\n          .setStyle(TextInputStyle.Short)\n          .setRequired(true);\n        modal.addComponents(new ActionRowBuilder().addComponents(amountInput));\n        return interaction.showModal(modal);\n      }\n\n      // Withdraw\n      if (action === \"withdraw\") {\n        if (!hasPermission(interaction.member, \"addBalance\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n\n        const modal = new ModalBuilder().setCustomId(`withdrawModal_${userId}`).setTitle(\"Ø³Ø­Ø¨ Ø±ØµÙŠØ¯\");\n        const amountInput = new TextInputBuilder()\n          .setCustomId(\"amount\")\n          .setLabel(\"Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨\")\n          .setStyle(TextInputStyle.Short)\n          .setRequired(true);\n        modal.addComponents(new ActionRowBuilder().addComponents(amountInput));\n        return interaction.showModal(modal);\n      }\n\n      // Promote â†’ row of ranks\n      if (action === \"promote\") {\n        if (!hasPermission(interaction.member, \"promote\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n        const rankRow = new ActionRowBuilder().addComponents(\n          ...(gconf.ranks || [\"Bronze\",\"Silver\",\"Gold\"]).map(r =>\n            new ButtonBuilder().setCustomId(`setrank_${userId}_${r}`).setLabel(r).setStyle(ButtonStyle.Secondary)\n          )\n        );\n        return interaction.reply({ content: `Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€ <@${userId}>:`, components: [rankRow], flags: 64 });\n      }\n\n      if (action === \"setrank\") {\n        if (!hasPermission(interaction.member, \"promote\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n        target.rank = extra;\n        saveUsers(users);\n        await Sheets.onUserChange?.({ id: userId, ...target }).catch(() => {});\n        await interaction.update({ content: `ğŸ“ˆ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØªØ¨Ø© <@${userId}> Ø¥Ù„Ù‰ **${extra}**`, components: [] });\n        await pushLog(interaction.guildId, `ğŸ“ˆ Ø±ØªØ¨Ø© <@${userId}> Ø£ØµØ¨Ø­Øª **${extra}** Ø¨ÙˆØ§Ø³Ø·Ø© ${interaction.user.username}`);\n        return;\n      }\n\n      // Freeze / Unfreeze\n      if (action === \"freeze\" || action === \"unfreeze\") {\n        if (!hasPermission(interaction.member, \"freeze\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n        target.frozen = (action === \"freeze\");\n        saveUsers(users);\n        await interaction.reply({ content: `ØªÙ… ${target.frozen ? \"ØªØ¬Ù…ÙŠØ¯\" : \"Ø¥Ù„ØºØ§Ø¡ ØªØ¬Ù…ÙŠØ¯\"} Ø­Ø³Ø§Ø¨ <@${userId}>.`, flags: 64 });\n        await pushLog(interaction.guildId, `${target.frozen ? \"ğŸ§Š\" : \"ğŸ”¥\"} ${target.frozen ? \"ØªÙ… ØªØ¬Ù…ÙŠØ¯\" : \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ¬Ù…ÙŠØ¯\"} Ø­Ø³Ø§Ø¨ <@${userId}> Ø¨ÙˆØ§Ø³Ø·Ø© ${interaction.user.username}`);\n        return;\n      }\n\n      // Edit fees\n      if (action === \"fees\") {\n        if (!hasPermission(interaction.member, \"editFee\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n        const modal = new ModalBuilder().setCustomId(\"feesModal\").setTitle(\"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨Ù†ÙƒÙŠØ©\");\n        const dep = new TextInputBuilder().setCustomId(\"deposit\").setLabel(\"Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ %\").setStyle(TextInputStyle.Short).setRequired(true);\n        const trn = new TextInputBuilder().setCustomId(\"transfer\").setLabel(\"Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ %\").setStyle(TextInputStyle.Short).setRequired(true);\n        const wdr = new TextInputBuilder().setCustomId(\"withdraw\").setLabel(\"Ø±Ø³ÙˆÙ… Ø§Ù„Ø³Ø­Ø¨ %\").setStyle(TextInputStyle.Short).setRequired(true);\n        modal.addComponents(\n          new ActionRowBuilder().addComponents(dep),\n          new ActionRowBuilder().addComponents(trn),\n          new ActionRowBuilder().addComponents(wdr),\n        );\n        return interaction.showModal(modal);\n      }\n\n      // Edit user info\n      if (action === \"editInfo\") {\n        if (!hasPermission(interaction.member, \"editInfo\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n        \n        const modal = new ModalBuilder().setCustomId(`editInfoModal_${userId}`).setTitle(\"ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\");\n        const nameInput = new TextInputBuilder().setCustomId(\"name\").setLabel(\"Ø§Ù„Ø§Ø³Ù…\").setStyle(TextInputStyle.Short).setValue(target.name || \"\").setRequired(true);\n        const countryInput = new TextInputBuilder().setCustomId(\"country\").setLabel(\"Ø§Ù„Ø¨Ù„Ø¯\").setStyle(TextInputStyle.Short).setValue(target.country || \"\").setRequired(true);\n        const ageInput = new TextInputBuilder().setCustomId(\"age\").setLabel(\"Ø§Ù„Ø¹Ù…Ø±\").setStyle(TextInputStyle.Short).setValue(String(target.age || \"\")).setRequired(true);\n        const birthInput = new TextInputBuilder().setCustomId(\"birth\").setLabel(\"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (YYYY-MM-DD)\").setStyle(TextInputStyle.Short).setValue(target.birth || \"\").setRequired(true);\n        const incomeInput = new TextInputBuilder().setCustomId(\"income\").setLabel(\"Ø§Ù„Ø¯Ø®Ù„\").setStyle(TextInputStyle.Short).setValue(String(target.income || 0)).setRequired(true);\n        \n        modal.addComponents(\n          new ActionRowBuilder().addComponents(nameInput),\n          new ActionRowBuilder().addComponents(countryInput),\n          new ActionRowBuilder().addComponents(ageInput),\n          new ActionRowBuilder().addComponents(birthInput),\n          new ActionRowBuilder().addComponents(incomeInput)\n        );\n        return interaction.showModal(modal);\n      }\n\n      // Blacklist user\n      if (action === \"blacklist\") {\n        if (!hasPermission(interaction.member, \"blacklist\", gconf))\n          return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n        if (!target) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n        \n        target.status = \"blacklisted\";\n        target.frozen = true;\n        saveUsers(users);\n        await Sheets.onUserChange?.({ id: userId, ...target }).catch(() => {});\n        await interaction.reply({ content: `â›” ØªÙ… Ø¥Ø¶Ø§ÙØ© <@${userId}> Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡.`, flags: 64 });\n        await pushLog(interaction.guildId, `â›” <@${interaction.user.id}> Ø£Ø¶Ø§Ù <@${userId}> Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡`);\n        return;\n      }\n    }\n\n    // ====== Modals ======\n\n    // Add balance submit\n    if (interaction.isModalSubmit() && interaction.customId.startsWith(\"addBalanceModal_\")) {\n      if (!hasPermission(interaction.member, \"addBalance\", gconf))\n        return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n      const userId = interaction.customId.split(\"_\")[1];\n      const users = loadUsers();\n      const user = users[userId];\n      if (!user) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n\n      const amount = parseFloat(interaction.fields.getTextInputValue(\"amount\"));\n      if (isNaN(amount) || amount <= 0) return interaction.reply({ content: \"Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 0.\", flags: 64 });\n\n      user.balance = (user.balance || 0) + amount;\n      saveUsers(users);\n\n      pushTx({ type: \"admin_deposit\", guildId: interaction.guildId, to: userId, amount, fee: 0 });\n\n      // Log to transaction channel\n      const depositEmbed = new EmbedBuilder()\n        .setColor(0x2ecc71)\n        .setTitle(\"â• Ø¥ÙŠØ¯Ø§Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ\")\n        .addFields(\n          { name: \"Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„\", value: `<@${interaction.user.id}>`, inline: true },\n          { name: \"Ø§Ù„Ù…Ø³ØªÙ„Ù…\", value: `<@${userId}> (${user.name || \"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ\"})`, inline: true },\n          { name: \"Ø§Ù„Ù…Ø¨Ù„Øº\", value: `${amount}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true },\n          { name: \"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯\", value: `${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true }\n        )\n        .setTimestamp();\n      \n      logTransaction(interaction.guildId, depositEmbed);\n      await pushLog(interaction.guildId, `ğŸ’° <@${interaction.user.id}> Ø£Ø¶Ø§Ù ${amount}${gconf.CURRENCY_SYMBOL || \"$\"} Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ <@${userId}>. Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`);\n\n      await interaction.reply({ content: `âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount}${gconf.CURRENCY_SYMBOL || \"$\"} Ø¥Ù„Ù‰ <@${userId}>. Ø§Ù„Ø±ØµÙŠØ¯: ${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`, flags: 64 });\n      return;\n    }\n\n    // Withdraw submit\n    if (interaction.isModalSubmit() && interaction.customId.startsWith(\"withdrawModal_\")) {\n      if (!hasPermission(interaction.member, \"addBalance\", gconf))\n        return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n      const userId = interaction.customId.split(\"_\")[1];\n      const users = loadUsers();\n      const user = users[userId];\n      if (!user) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n      if (user.frozen) return interaction.reply({ content: \"Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…Ù‘Ø¯. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨.\", flags: 64 });\n\n      const amount = parseFloat(interaction.fields.getTextInputValue(\"amount\"));\n      if (isNaN(amount) || amount <= 0) return interaction.reply({ content: \"Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 0.\", flags: 64 });\n\n      const feePct = gconf.fees?.WITHDRAW_FEE || 0;\n      const fee = Math.floor((amount * feePct) / 100);\n      const totalDebit = amount + fee;\n\n      if ((user.balance || 0) < totalDebit)\n        return interaction.reply({ content: \"Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ.\", flags: 64 });\n\n      user.balance = (user.balance || 0) - totalDebit;\n      saveUsers(users);\n\n      pushTx({ type: \"admin_withdraw\", guildId: interaction.guildId, from: userId, amount, fee });\n\n      // Log to transaction channel\n      const withdrawEmbed = new EmbedBuilder()\n        .setColor(0xe67e22)\n        .setTitle(\"â– Ø³Ø­Ø¨ Ø¥Ø¯Ø§Ø±ÙŠ\")\n        .addFields(\n          { name: \"Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„\", value: `<@${interaction.user.id}>`, inline: true },\n          { name: \"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\", value: `<@${userId}> (${user.name || \"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ\"})`, inline: true },\n          { name: \"Ø§Ù„Ù…Ø¨Ù„Øº\", value: `${amount}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true },\n          { name: \"Ø§Ù„Ø±Ø³ÙˆÙ…\", value: `${fee}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true },\n          { name: \"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨\", value: `${totalDebit}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true },\n          { name: \"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ\", value: `${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`, inline: true }\n        )\n        .setTimestamp();\n      \n      logTransaction(interaction.guildId, withdrawEmbed);\n      await pushLog(interaction.guildId, `ğŸ’¸ <@${interaction.user.id}> Ø³Ø­Ø¨ ${amount}${gconf.CURRENCY_SYMBOL || \"$\"} Ù…Ù† Ø­Ø³Ø§Ø¨ <@${userId}> (Ø±Ø³ÙˆÙ…: ${fee}${gconf.CURRENCY_SYMBOL || \"$\"}). Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`);\n\n      await interaction.reply({ content: `âœ… ØªÙ… Ø³Ø­Ø¨ ${amount}${gconf.CURRENCY_SYMBOL || \"$\"} Ù…Ù† <@${userId}> (Ø±Ø³Ù…: ${fee}${gconf.CURRENCY_SYMBOL || \"$\"}). Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${user.balance}${gconf.CURRENCY_SYMBOL || \"$\"}`, flags: 64 });\n      return;\n    }\n\n    // Fees modal submit\n    if (interaction.isModalSubmit() && interaction.customId === \"feesModal\") {\n      if (!hasPermission(interaction.member, \"editFee\", gconf))\n        return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n      const dep = Number(interaction.fields.getTextInputValue(\"deposit\"));\n      const trn = Number(interaction.fields.getTextInputValue(\"transfer\"));\n      const wdr = Number(interaction.fields.getTextInputValue(\"withdraw\"));\n      for (const v of [dep, trn, wdr]) {\n        if (!Number.isFinite(v) || v < 0 || v > 100) {\n          return interaction.reply({ content: \"ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø±Ø³ÙˆÙ… Ø¨ÙŠÙ† 0 Ùˆ 100.\", flags: 64 });\n        }\n      }\n      GC.patch(interaction.guildId, { fees: { DEPOSIT_FEE: dep, TRANSFER_FEE: trn, WITHDRAW_FEE: wdr } });\n      await pushLog(interaction.guildId, `ğŸ’µ <@${interaction.user.id}> Ù‚Ø§Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ…: Ø¥ÙŠØ¯Ø§Ø¹ ${dep}% â€¢ ØªØ­ÙˆÙŠÙ„ ${trn}% â€¢ Ø³Ø­Ø¨ ${wdr}%`);\n      return interaction.reply({ content: `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ…: Ø¥ÙŠØ¯Ø§Ø¹ ${dep}% â€¢ ØªØ­ÙˆÙŠÙ„ ${trn}% â€¢ Ø³Ø­Ø¨ ${wdr}%`, flags: 64 });\n    }\n\n    // Edit info modal submit\n    if (interaction.isModalSubmit() && interaction.customId.startsWith(\"editInfoModal_\")) {\n      if (!hasPermission(interaction.member, \"editInfo\", gconf))\n        return interaction.reply({ content: \"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.\", flags: 64 });\n\n      const userId = interaction.customId.split(\"_\")[1];\n      const users = loadUsers();\n      const user = users[userId];\n      if (!user) return interaction.reply({ content: \"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\", flags: 64 });\n\n      const name = interaction.fields.getTextInputValue(\"name\").trim();\n      const country = interaction.fields.getTextInputValue(\"country\").trim();\n      const age = parseInt(interaction.fields.getTextInputValue(\"age\").trim(), 10);\n      const birth = interaction.fields.getTextInputValue(\"birth\").trim();\n      const income = parseInt(interaction.fields.getTextInputValue(\"income\").trim(), 10);\n\n      if (!name || !country || !Number.isFinite(age) || age < 1 || age > 150 ||\n          !/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(birth) || !Number.isFinite(income) || income < 0) {\n        return interaction.reply({ content: \"Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©.\", flags: 64 });\n      }\n\n      // Defer to prevent timeout\n      await interaction.deferReply({ flags: 64 });\n\n      user.name = name;\n      user.country = country;\n      user.age = age;\n      user.birth = birth;\n      user.income = income;\n      user.updatedAt = new Date().toISOString();\n\n      saveUsers(users);\n      await Sheets.onUserChange?.({ id: userId, ...user }).catch(() => {});\n\n      await pushLog(interaction.guildId, `âœï¸ ${interaction.user.username} Ù‚Ø§Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª <@${userId}>`);\n      return interaction.editReply({ content: `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª <@${userId}> Ø¨Ù†Ø¬Ø§Ø­.` });\n    }\n\n    // Register modal submit â†’ prompt Ø§Ù„Ø­Ø§Ù„Ø© (and maybe Ø§Ù„ÙØµÙŠÙ„)\n    if (interaction.isModalSubmit() && interaction.customId === \"registerModal\") {\n      if (gconf.REGISTER_CHANNEL_ID && interaction.channelId !== gconf.REGISTER_CHANNEL_ID) {\n        return interaction.reply({ content: `ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø· Ù…Ù† Ø¯Ø§Ø®Ù„ <#${gconf.REGISTER_CHANNEL_ID}>.`, flags: 64 });\n      }\n\n      const name = interaction.fields.getTextInputValue(\"name\").trim();\n      const country = interaction.fields.getTextInputValue(\"country\").trim();\n      const age = parseInt(interaction.fields.getTextInputValue(\"age\").trim(), 10);\n      const birth = interaction.fields.getTextInputValue(\"birth\").trim();\n      const income = parseInt(interaction.fields.getTextInputValue(\"income\").trim(), 10);\n\n      if (!name || !country || !Number.isFinite(age) || age < 16 || age > 65 ||\n          !/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(birth) || !Number.isFinite(income) || income <= 0) {\n        return interaction.reply({ content: \"Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ ØµØ­ÙŠØ­Ø©.\", flags: 64 });\n      }\n      if (income < (gconf.MIN_DEPOSIT || 0)) {\n        return interaction.reply({ content: `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯Ø®Ù„ Ù‡Ùˆ ${gconf.MIN_DEPOSIT} ${gconf.CURRENCY_SYMBOL || \"$\"}.`, flags: 64 });\n      }\n\n      // stash draft\n      regDraft.set(interaction.user.id, { name, country, age, birth, income });\n\n      // Ø§Ù„Ø­Ø§Ù„Ø© + fallback button\n      const statusSelect = new StringSelectMenuBuilder()\n        .setCustomId(\"reg_status_after\")\n        .setPlaceholder(\"Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©\")\n        .addOptions(\n          { label: \"Ù…Ø¯Ù†ÙŠ\", value: \"Ù…Ø¯Ù†ÙŠ\" },\n          { label: \"Ø¹ØµØ§Ø¨Ø©\", value: \"Ø¹ØµØ§Ø¨Ø©\" },\n          { label: \"ÙØµÙŠÙ„\", value: \"ÙØµÙŠÙ„\" },\n        );\n\n      const confirmBtn = new ButtonBuilder()\n        .setCustomId(\"reg_submit_after\")\n        .setLabel(\"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\")\n        .setStyle(ButtonStyle.Primary);\n\n      return interaction.reply({\n        content: \"ğŸ“‹ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬. Ø§Ø®ØªØ± **Ø§Ù„Ø­Ø§Ù„Ø©**.\\nØ¥Ø°Ø§ Ø§Ø®ØªØ±Øª **ÙØµÙŠÙ„** Ø³ÙŠØ¸Ù‡Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙŠÙ„ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.\",\n        components: [\n          new ActionRowBuilder().addComponents(statusSelect),\n          new ActionRowBuilder().addComponents(confirmBtn),\n        ],\n        flags: 64,\n      });\n    }\n\n  } catch (err) {\n    console.error(\"interaction error:\", err);\n  }\n});\n\n// ===== finalize registration helper =====\nasync function finalizeRegistration(interaction, draft) {\n  try {\n    const gconf = GC.get(interaction.guildId);\n    if (!draft?.kind)\n      return interaction.reply?.({ content: \"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø©.\", flags: 64 });\n    if (draft.kind === \"ÙØµÙŠÙ„\" && !draft.faction)\n      return interaction.reply?.({ content: \"Ø§Ø®ØªØ± Ø§Ù„ÙØµÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.\", flags: 64 });\n\n    const U = loadUsers();\n    const id = interaction.user.id;\n    const existing = U[id];\n    if (existing && existing.status !== \"rejected\") {\n      let reason = \"Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø­Ø§Ù„ÙŠÙ‹Ø§.\";\n      if (existing.status === \"pending\") reason = \"Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„.\";\n      else if (existing.status === \"approved\") reason = \"Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.\";\n      else if (existing.status === \"blacklisted\") reason = \"ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.\";\n      return interaction.reply?.({ content: `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: **${reason}**`, flags: 64 });\n    }\n\n    // Defer the interaction to prevent timeout\n    if ((interaction.isAnySelectMenu?.() || interaction.isButton?.()) && !interaction.replied && !interaction.deferred) {\n      await interaction.deferUpdate();\n    }\n\n    U[id] = {\n      name: draft.name,\n      country: draft.country,\n      age: draft.age,\n      birth: draft.birth,\n      income: draft.income,\n      rank: existing?.rank || (gconf.ranks?.[0] || \"Bronze\"),\n      balance: existing?.balance ?? 0,\n      status: \"pending\",\n      kind: draft.kind,\n      faction: draft.kind === \"ÙØµÙŠÙ„\" ? (draft.faction || \"ØºÙŠØ± Ù…Ø­Ø¯Ø¯\") : null,\n    };\n    saveUsers(U);\n    \n    // Do async operations without blocking\n    Promise.all([\n      Sheets.onUserChange?.({ id, ...U[id] }).catch(() => {}),\n      updateRegList(interaction.guildId)\n    ]).catch(() => {});\n\n    // clear the ephemeral UI\n    if (interaction.deferred) {\n      await interaction.editReply({ content: \"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.\", components: [] });\n    } else if (interaction.isAnySelectMenu?.() || interaction.isButton?.()) {\n      await interaction.update({ content: \"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.\", components: [] });\n    } else if (!interaction.replied) {\n      await interaction.reply({ content: \"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.\", flags: 64 });\n    }\n\n    // emit card to review channel\n    client.emit(\"userRegistered\", {\n      id,\n      mention: `<@${id}>`,\n      tag: interaction.user.tag,\n      avatar: interaction.user.displayAvatarURL({ size: 256 }),\n      ...U[id],\n    }, interaction.guildId);\n    regDraft.delete(id);\n  } catch (e) {\n    console.error(\"finalizeRegistration error:\", e);\n    if (!interaction.replied && !interaction.deferred) {\n      await interaction.reply({ content: \"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.\", flags: 64 }).catch(() => {});\n    } else if (interaction.deferred) {\n      await interaction.editReply({ content: \"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.\" }).catch(() => {});\n    }\n  }\n}\n\n// ===== review card sender =====\nclient.on(\"userRegistered\", async (user, guildId) => {\n  try {\n    const gconf = GC.get(guildId);\n    const reviewChannel =\n      client.channels.cache.get(gconf.ADMIN_CHANNEL_ID) ||\n      (await client.channels.fetch?.(gconf.ADMIN_CHANNEL_ID).catch(() => null));\n    if (!reviewChannel) {\n      await pushLog(guildId, `âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø¥ÙŠØ¬Ø§Ø¯ Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (ID: ${gconf.ADMIN_CHANNEL_ID}).`);\n      return;\n    }\n    if (![ChannelType.GuildText, ChannelType.PublicThread, ChannelType.PrivateThread, ChannelType.GuildAnnouncement].includes(reviewChannel.type)) {\n      await pushLog(guildId, `âš ï¸ Ø§Ù„Ù‚Ù†Ø§Ø© (${gconf.ADMIN_CHANNEL_ID}) Ù„ÙŠØ³Øª Ù‚Ù†Ø§Ø© Ù†ØµÙŠØ©.`);\n      return;\n    }\n\n    const embed = new EmbedBuilder()\n      .setColor(0x57f287)\n      .setTitle(\"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\")\n      .setThumbnail(user.avatar)\n      .setDescription(`${user.mention} â€” \\n${user.tag}`)\n      .addFields(\n        { name: \"Ø§Ù„Ø§Ø³Ù…\", value: String(user.name || \"â€”\"), inline: true },\n        { name: \"Ø§Ù„Ø¨Ù„Ø¯\", value: String(user.country || \"â€”\"), inline: true },\n        { name: \"Ø§Ù„Ø¹Ù…Ø±\", value: String(user.age ?? \"â€”\"), inline: true },\n        { name: \"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯\", value: String(user.birth || \"â€”\"), inline: true },\n        { name: \"Ø§Ù„Ø¯Ø®Ù„\", value: String(user.income ?? 0), inline: true },\n        { name: \"Ø§Ù„Ø±ØªØ¨Ø©\", value: String(user.rank || \"â€”\"), inline: true },\n        { name: \"Ø§Ù„Ø±ØµÙŠØ¯\", value: String(user.balance ?? 0), inline: true },\n        { name: \"Ø§Ù„Ø­Ø§Ù„Ø©\", value: String(user.status || \"pending\"), inline: true },\n        { name: \"Ø§Ù„Ù†ÙˆØ¹\", value: String(user.kind || \"â€”\"), inline: true },\n        { name: \"ÙØµÙŠÙ„\", value: String(user.faction || \"â€”\"), inline: true },\n        { name: \"ID\", value: String(user.id), inline: false },\n      );\n\n    const row1 = new ActionRowBuilder().addComponents(\n      new ButtonBuilder().setCustomId(`approve_${user.id}`).setLabel(\"Ù…ÙˆØ§ÙÙ‚Ø©\").setStyle(ButtonStyle.Success),\n      new ButtonBuilder().setCustomId(`reject_${user.id}`).setLabel(\"Ø±ÙØ¶\").setStyle(ButtonStyle.Danger),\n    );\n\n    await reviewChannel.send({ embeds: [embed], components: [row1] });\n  } catch (e) {\n    console.error(\"userRegistered send error:\", e);\n  }\n});\n\nclient.login(process.env.TOKEN);\n","size_bytes":33025},"commands/withdraw.js":{"content":"const { SlashCommandBuilder, EmbedBuilder } = require(\"discord.js\");\nconst GC = require(\"../guildConfig\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"withdraw\")\n    .setDescription(\"Ø³Ø­Ø¨ Ø±ØµÙŠØ¯ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ\")\n    .addIntegerOption(o => o.setName(\"amount\").setDescription(\"Ø§Ù„Ù…Ø¨Ù„Øº\").setRequired(true)),\n\n  async execute(interaction, { gconf, users, saveUsers, pushTx, logTransaction, pushLog }) {\n    const g = gconf();\n    const uid = interaction.user.id;\n    const amount = interaction.options.getInteger(\"amount\");\n    const U = users();\n    const A = U[uid];\n    if (!A) return interaction.reply({ content:\"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨.\", flags: 64 });\n    if (A.frozen) return interaction.reply({ content:\"Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯.\", flags: 64 });\n    if (amount <= 0) return interaction.reply({ content:\"Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­.\", flags: 64 });\n\n    const fee = Math.floor((amount*(g.fees.WITHDRAW_FEE||0))/100);\n    const total = amount + fee;\n    if ((A.balance||0) < total) return interaction.reply({ content:\"Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ.\", flags: 64 });\n\n    // daily limit\n    const key = new Date().toISOString().slice(0,10);\n    A._daily = A._daily || {};\n    const spent = A._daily[key] || 0;\n    if (spent + total > (g.DAILY_WITHDRAW_LIMIT||Infinity))\n      return interaction.reply({ content:`ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ (${g.DAILY_WITHDRAW_LIMIT}${g.CURRENCY_SYMBOL}).`, flags: 64 });\n\n    A.balance -= total;\n    A._daily[key] = spent + total;\n    saveUsers(U, interaction.guild);\n    pushTx({ type:\"withdraw\", guildId: interaction.guildId, from:uid, amount, fee });\n\n    // Log to transaction channel\n    const embed = new EmbedBuilder()\n      .setColor(0xe74c3c)\n      .setTitle(\"ğŸ’° Ø³Ø­Ø¨ Ø±ØµÙŠØ¯\")\n      .addFields(\n        { name: \"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\", value: `<@${uid}> (${A.name || \"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ\"})`, inline: true },\n        { name: \"Ø§Ù„Ù…Ø¨Ù„Øº\", value: `${amount}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø±Ø³ÙˆÙ…\", value: `${fee}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨\", value: `${total}${g.CURRENCY_SYMBOL}`, inline: true },\n        { name: \"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ\", value: `${A.balance}${g.CURRENCY_SYMBOL}`, inline: true }\n      )\n      .setTimestamp();\n    \n    logTransaction(interaction.guildId, embed);\n    await pushLog(interaction.guildId, `ğŸ’° <@${uid}> Ø³Ø­Ø¨ ${amount}${g.CURRENCY_SYMBOL} (Ø±Ø³ÙˆÙ… ${fee}${g.CURRENCY_SYMBOL}). Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${A.balance}${g.CURRENCY_SYMBOL}`);\n\n    return interaction.reply({ content:`ğŸ’¸ ØªÙ… Ø³Ø­Ø¨ ${amount}${g.CURRENCY_SYMBOL} (Ø±Ø³ÙˆÙ… ${fee}).`, flags: 64 });\n  }\n};\n","size_bytes":2683},"commands/reglist.js":{"content":"// commands/reglist.js â€” post a grouped list of registrations\nconst { SlashCommandBuilder, EmbedBuilder } = require(\"discord.js\");\nconst fs = require(\"fs\");\nconst GC = require(\"../guildConfig\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"reglist\")\n    .setDescription(\"Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (Ù…Ø¬Ù…Ù‘Ø¹Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø©)\"),\n\n  async execute(interaction) {\n    const users = JSON.parse(fs.readFileSync(\"./database/users.json\", \"utf8\") || \"{}\");\n\n    const groups = { pending: [], approved: [], rejected: [], blacklisted: [] };\n    for (const id of Object.keys(users)) {\n      const u = users[id];\n      const st = (u.status || \"pending\").toLowerCase();\n      (groups[st] || groups.pending).push({ id, name: u.name || id });\n    }\n\n    const mk = (arr, title) => {\n      if (!arr.length) return `**${title}:** â€”`;\n      const lines = arr.slice(0, 25).map(x => `â€¢ ${x.name} (<@${x.id}>)`);\n      return `**${title}:**\\n${lines.join(\"\\n\")}${arr.length > 25 ? `\\nâ€¦ (+${arr.length-25})` : \"\"}`;\n    };\n\n    const embed = new EmbedBuilder()\n      .setColor(0x2b2d31)\n      .setTitle(\"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†\")\n      .setDescription(\n        [ mk(groups.pending, \"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\"),\n          mk(groups.approved, \"Ù…Ù‚Ø¨ÙˆÙ„\"),\n          mk(groups.rejected, \"Ù…Ø±ÙÙˆØ¶\"),\n          mk(groups.blacklisted, \"Ù‚Ø§Ø¦Ù…Ø© Ø³ÙˆØ¯Ø§Ø¡\")\n        ].join(\"\\n\\n\")\n      );\n\n    await interaction.reply({ embeds: [embed], flags: 64 });\n  },\n};\n","size_bytes":1483},"test-sheets.js":{"content":"const { google } = require('googleapis');\n\n(async () => {\n  try {\n    const auth = new google.auth.JWT({\n      email: process.env.GOOGLE_CLIENT_EMAIL,\n      key: (process.env.GOOGLE_PRIVATE_KEY || '').replace(/\\\\n/g, '\\n'),\n      scopes: ['https://www.googleapis.com/auth/spreadsheets']\n    });\n    \n    await auth.authorize();\n    console.log('âœ… Authentication successful!');\n    \n    const sheets = google.sheets({ version: 'v4', auth });\n    const sheetId = process.env.SHEET_ID;\n\n    // Get spreadsheet info\n    const info = await sheets.spreadsheets.get({ spreadsheetId: sheetId });\n    console.log('âœ… Spreadsheet:', info.data.properties.title);\n    console.log('âœ… Available sheets:', info.data.sheets.map(s => s.properties.title).join(', '));\n    \n    // Try to get Users sheet (will fail if it doesn't exist yet)\n    try {\n      const res = await sheets.spreadsheets.values.get({\n        spreadsheetId: sheetId,\n        range: 'Users!A1:Z1',\n      });\n      console.log('âœ… Users sheet header:', res.data.values?.[0] || '(empty)');\n    } catch (e) {\n      console.log('â„¹ï¸ Users sheet not created yet (will be created automatically when bot syncs data)');\n    }\n    \n  } catch (e) {\n    console.error('âŒ Sheets test failed:', e.message);\n    if (e?.response?.data) {\n      console.error('Details:', e.response.data);\n    }\n  }\n})();","size_bytes":1351},"test-auth.js":{"content":"require('dotenv').config();\nconst { google } = require('googleapis');\n\n(async () => {\n  try {\n    console.log('Testing Google Sheets authentication...\\n');\n    \n    const email = process.env.GOOGLE_CLIENT_EMAIL;\n    const rawKey = process.env.GOOGLE_PRIVATE_KEY || '';\n    const sheetId = process.env.SHEET_ID;\n    \n    console.log('âœ“ Client email:', email ? email : 'âŒ MISSING');\n    console.log('âœ“ Sheet ID:', sheetId ? sheetId : 'âŒ MISSING');\n    console.log('âœ“ Private key length:', rawKey.length);\n    console.log('âœ“ Key has BEGIN marker:', rawKey.includes('BEGIN PRIVATE KEY'));\n    console.log('âœ“ Key has END marker:', rawKey.includes('END PRIVATE KEY'));\n    \n    let privateKey = rawKey.replace(/\\\\n/g, '\\n');\n    console.log('âœ“ After newline replacement:', privateKey.split('\\n').length, 'lines\\n');\n    \n    if (!privateKey.includes('\\n')) {\n      console.log('âš ï¸ No actual newlines found, trying different approach...');\n      privateKey = rawKey;\n    }\n    \n    console.log('Creating JWT auth...');\n    const auth = new google.auth.JWT(\n      email,\n      null,\n      privateKey,\n      ['https://www.googleapis.com/auth/spreadsheets']\n    );\n    \n    console.log('Attempting to authorize...');\n    await auth.authorize();\n    console.log('âœ… Authorization successful!\\n');\n    \n    console.log('Testing Sheets API access...');\n    const sheets = google.sheets({ version: 'v4', auth });\n    const res = await sheets.spreadsheets.values.get({\n      spreadsheetId: sheetId,\n      range: 'Users!A1:Z1',\n    });\n    \n    console.log('âœ… SUCCESS! Header row:', res.data.values?.[0] || '(empty sheet)');\n    \n  } catch (e) {\n    console.error('\\nâŒ Error:', e.message);\n    if (e.response?.data) {\n      console.error('Response data:', JSON.stringify(e.response.data, null, 2));\n    }\n  }\n})();\n","size_bytes":1824},"manual-sync.js":{"content":"require('dotenv').config();\nconst fs = require('fs');\nconst Sheets = require('./sheets');\n\n(async () => {\n  try {\n    console.log('Loading users from database...');\n    const users = JSON.parse(fs.readFileSync('./database/users.json', 'utf8'));\n    console.log('Users found:', Object.keys(users).length);\n    console.log('Users:', JSON.stringify(users, null, 2));\n    \n    console.log('\\nAttempting to sync to Google Sheets...');\n    await Sheets.syncUsers(users);\n    console.log('âœ… Sync successful!');\n  } catch (e) {\n    console.error('âŒ Sync failed:', e.message);\n    console.error(e);\n  }\n})();\n","size_bytes":604},"test-minimal.js":{"content":"require('dotenv').config();\nconst { google } = require('googleapis');\n\nconst client_email = process.env.GOOGLE_CLIENT_EMAIL;\nconst private_key = process.env.GOOGLE_PRIVATE_KEY.replace(/\\\\n/g, '\\n');\nconst spreadsheet_id = process.env.SHEET_ID;\n\nasync function test() {\n  const client = new google.auth.JWT({\n    email: client_email,\n    key: private_key,\n    scopes: ['https://www.googleapis.com/auth/spreadsheets'],\n  });\n\n  await client.authorize();\n  console.log('âœ… Auth successful!');\n\n  const sheets = google.sheets({ version: 'v4', auth: client });\n  const response = await sheets.spreadsheets.values.get({\n    spreadsheetId: spreadsheet_id,\n    range: 'Users!A1:Z1',\n  });\n\n  console.log('âœ… Sheet access successful!');\n  console.log('Header:', response.data.values?.[0] || '(empty)');\n}\n\ntest().catch(err => {\n  console.error('âŒ Error:', err.message);\n  console.error(err);\n});\n","size_bytes":891},"commands/restore.js":{"content":"const { SlashCommandBuilder, EmbedBuilder, PermissionFlagsBits } = require(\"discord.js\");\nconst { restoreUsersFromSheet } = require(\"../sheets\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\n\nmodule.exports = {\n  data: new SlashCommandBuilder()\n    .setName(\"restore\")\n    .setDescription(\"Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Google Sheets\")\n    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),\n\n  async execute(interaction, { saveUsers, pushLog }) {\n    await interaction.deferReply({ flags: 64 });\n\n    try {\n      const result = await restoreUsersFromSheet();\n\n      if (!result.success) {\n        return interaction.editReply({\n          content: `âŒ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ${result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,\n        });\n      }\n\n      if (result.count === 0) {\n        return interaction.editReply({\n          content: `âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Google Sheets Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.`,\n        });\n      }\n\n      const dbPath = path.join(process.cwd(), \"database\", \"users.json\");\n      if (!fs.existsSync(path.dirname(dbPath))) {\n        fs.mkdirSync(path.dirname(dbPath), { recursive: true });\n      }\n\n      fs.writeFileSync(dbPath, JSON.stringify(result.users, null, 2));\n\n      const embed = new EmbedBuilder()\n        .setColor(0x2ecc71)\n        .setTitle(\"âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­\")\n        .setDescription(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© **${result.count}** Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Google Sheets`)\n        .addFields(\n          { name: \"Ø§Ù„Ù…ØµØ¯Ø±\", value: \"Google Sheets (Users tab)\", inline: true },\n          { name: \"Ø§Ù„ÙˆØ¬Ù‡Ø©\", value: \"database/users.json\", inline: true },\n          { name: \"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\", value: String(result.count), inline: true }\n        )\n        .setTimestamp()\n        .setFooter({ text: \"Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†\" });\n\n      await pushLog(interaction.guildId, `ğŸ“¥ **Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª** - <@${interaction.user.id}> Ø§Ø³ØªØ¹Ø§Ø¯ ${result.count} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Google Sheets`);\n\n      return interaction.editReply({ embeds: [embed] });\n\n    } catch (error) {\n      console.error('Restore error:', error);\n      return interaction.editReply({\n        content: `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ${error.message}`,\n      });\n    }\n  }\n};\n","size_bytes":2352}},"version":2}